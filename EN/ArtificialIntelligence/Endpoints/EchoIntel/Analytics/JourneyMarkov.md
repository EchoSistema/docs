# Artificial Intelligence – Customer Journey (Markov)

## Endpoint

```
POST /api/v1/ai/echointel/analytics/journey-markov
```

Analyzes customer journey paths using Markov chain models to underste touchpoint sequences, predict conversion probabilities, and identify critical paths that lead to successful outcomes.

**Business Value:** Optimizes marketing touchpoint strategy by revealing which journey paths have the highest conversion probability, enabling targeted improvements that can increase conversion rates by 15-30%.

## Authentication

Required – Bearer {token} with middleware `auth:sanctum`

## Headers

| Header          | Type   | Required | Description |
| ------------------ | ------ | ----------- | --------- |
| Authorization      | string | Yes         | `Bearer {token}`. |
| X-Customer-Api-Id  | string | Conditional | Tenant UUID (v4). |
| X-Secret           | string | Conditional | 64-caracteres of segredo. |
| Accept-Language    | string | No         | Language (`en`, `es`, `pt`). |
| Content-Tipo       | string | Yes         | `application/json`. |

## Parameters

> **Note:** Os parâmetros aceitam tanto `snake_case` e `camelCase`.

### Corpo of the Requisição Parâmetros

| Parameter | Type | Required | Padrão | Description | Significado Empresarial |
|-----------|------|----------|---------|-------------|------------------|
| journey_data | array | Yes | - | array of customer journey sequences. Each journey contains ordered touchpoint events. | Customer interaction paths across marketing channels and touchpoints. |
| absorbing_states | array | No | `["conversion", "abeonment"]` | Terminal states that end the journey (e.g., purchase, churn). | Final outcomes that define journey Sucesso or failure. |
| min_support | float | No | `0.01` | Minimum frequency threshold for transitions (0-1). Filters rare transitions. | Excludes infrequent paths to focus on statistically significant patterns. |
| max_order | integer | No | `1` | Markov chain order (1=first-order, 2=second-order). Higher order considers more history. | Complexity of path dependencies: 1st order = last step only, 2nd order = last 2 steps. |
| include_probabilities | boolean | No | `true` | Include full transition probability matrix in Resposta. | Detailed transition data for advanced analysis and visualization. |
| identify_critical_paths | boolean | No | `true` | Identify high-probability paths to conversion. | Reveals the most effective journey sequences for optimization. |

### Journey Data object Fields

| Field | Type | Required | Description | Example |
|-------|------|----------|-------------|---------|
| journey_id | string | Yes | Unique identifier for the journey. | `"J00123"` |
| touchpoints | array | Yes | Ordered sequence of touchpoint events with timestamps. | `[{"event": "email_open", "timestamp": "2025-11-01T10:00:00Z"}, ...]` |
| outcome | string | Yes | Final outcome state (must match absorbing_states). | `"conversion"` |
| revenue | float | No | Revenue generated by this journey (for value-weighted analysis). | `299.99` |

### Touchpoint Event Fields

| Field | Type | Required | Description | Example |
|-------|------|----------|-------------|---------|
| event | string | Yes | Touchpoint Tipo or channel name. | `"paid_search"`, `"website_visit"`, `"email_click"` |
| timestamp | string | Yes | ISO 8601 timestamp of the touchpoint. | `"2025-11-01T10:30:00Z"` |
| metadata | object | No | Additional touchpoint metadata (campaign, source, etc.). | `{"campaign_id": "CAMP123"}` |

## Examples

### Exemplo of Requisição (curl)

```bash
curl -X POST \
  -H "Authorization: Bearer <token>" \
  -H "X-Customer-Api-Id: <tenant-uuid>" \
  -H "X-Secret: <secret>" \
  -H "Accept-Language: en" \
  -H "Content-Type: application/json" \
  -d '{
    "journey_data": [
      {
        "journey_id": "J001",
        "touchpoints": [
          {"event": "paid_search", "timestamp": "2025-11-01T10:00:00Z"},
          {"event": "website_visit", "timestamp": "2025-11-01T10:05:00Z"},
          {"event": "product_view", "timestamp": "2025-11-01T10:10:00Z"},
          {"event": "add_to_cart", "timestamp": "2025-11-01T10:15:00Z"}
        ],
        "outcome": "conversion",
        "revenue": 299.99
      },
      {
        "journey_id": "J002",
        "touchpoints": [
          {"event": "organic_search", "timestamp": "2025-11-02T14:00:00Z"},
          {"event": "website_visit", "timestamp": "2025-11-02T14:03:00Z"}
        ],
        "outcome": "abandonment"
      }
    ],
    "absorbing_states": ["conversion", "abandonment"],
    "min_support": 0.01,
    "max_order": 1,
    "identify_critical_paths": true
  }' \
  "https://echosistema.online/api/v1/ai/echointel/analytics/journey-markov"
```

### Exemplo of Requisição (JavaScript)

```javascript
const response = await fetch('https://echosistema.online/api/v1/ai/echointel/analytics/journey-markov', {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer <token>',
    'X-Customer-Api-Id': '<tenant-uuid>',
    'X-Secret': '<secret>',
    'Accept-Language': 'en',
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({
    journey_data: [
      {
        journey_id: 'J001',
        touchpoints: [
          {event: 'paid_search', timestamp: '2025-11-01T10:00:00Z'},
          {event: 'website_visit', timestamp: '2025-11-01T10:05:00Z'},
          {event: 'product_view', timestamp: '2025-11-01T10:10:00Z'},
          {event: 'add_to_cart', timestamp: '2025-11-01T10:15:00Z'}
        ],
        outcome: 'conversion',
        revenue: 299.99
      }
    ],
    absorbing_states: ['conversion', 'abandonment'],
    min_support: 0.01,
    identify_critical_paths: true
  })
});

const result = await response.json();
```

### Exemplo of Requisição (PHP)

```php
<?php

use Illuminate\Support\Facades\Http;

$response = Http::withHeaders([
    'Authorization' => 'Bearer ' . $token,
    'X-Customer-Api-Id' => $tenantUuid,
    'X-Secret' => $secret,
    'Accept-Language' => 'en',
])->post('https://echosistema.online/api/v1/ai/echointel/analytics/journey-markov', [
    'journey_data' => [
        [
            'journey_id' => 'J001',
            'touchpoints' => [
                ['event' => 'paid_search', 'timestamp' => '2025-11-01T10:00:00Z'],
                ['event' => 'website_visit', 'timestamp' => '2025-11-01T10:05:00Z'],
                ['event' => 'product_view', 'timestamp' => '2025-11-01T10:10:00Z'],
                ['event' => 'add_to_cart', 'timestamp' => '2025-11-01T10:15:00Z'],
            ],
            'outcome' => 'conversion',
            'revenue' => 299.99,
        ],
    ],
    'absorbing_states' => ['conversion', 'abandonment'],
    'min_support' => 0.01,
    'identify_critical_paths' => true,
]);

$result = $response->json();
```

## Response

### Success `200 OK`

```json
{
  "transition_matrix": {
    "paid_search": {
      "website_visit": 0.78,
      "abandonment": 0.22
    },
    "website_visit": {
      "product_view": 0.45,
      "category_browse": 0.28,
      "abandonment": 0.27
    },
    "product_view": {
      "add_to_cart": 0.62,
      "website_visit": 0.18,
      "abandonment": 0.20
    },
    "add_to_cart": {
      "conversion": 0.71,
      "abandonment": 0.29
    }
  },
  "conversion_probabilities": {
    "paid_search": 0.24,
    "website_visit": 0.18,
    "product_view": 0.44,
    "add_to_cart": 0.71,
    "email_click": 0.31,
    "organic_search": 0.15
  },
  "critical_paths": [
    {
      "path": ["paid_search", "website_visit", "product_view", "add_to_cart", "conversion"],
      "probability": 0.154,
      "avg_revenue": 312.45,
      "frequency": 1247,
      "avg_path_length": 5
    },
    {
      "path": ["email_click", "website_visit", "product_view", "conversion"],
      "probability": 0.089,
      "avg_revenue": 275.80,
      "frequency": 892,
      "avg_path_length": 4
    },
    {
      "path": ["organic_search", "website_visit", "add_to_cart", "conversion"],
      "probability": 0.067,
      "avg_revenue": 198.50,
      "frequency": 534,
      "avg_path_length": 4
    }
  ],
  "journey_metrics": {
    "avg_path_length_to_conversion": 4.7,
    "avg_path_length_to_abandonment": 2.3,
    "overall_conversion_rate": 0.187,
    "total_journeys_analyzed": 15420,
    "unique_states": 18,
    "total_transitions": 45678
  },
  "absorbing_states_distribution": {
    "conversion": 0.187,
    "abandonment": 0.813
  }
}
```

### Error `400 Bad Request`

```json
{
  "error": "Invalid parameters",
  "message": "The journey_data field is required and must contain at least one journey."
}
```

### Error `422 Unprocessable Entity`

```json
{
  "error": "Validation failed",
  "message": "Invalid journey data structure",
  "details": {
    "journey_data.0.touchpoints": "Touchpoints must be an array with at least 2 events.",
    "journey_data.0.outcome": "Outcome must match one of the absorbing_states."
  }
}
```

## Campo Reference

| Field | Type | Description | Significado Empresarial |
|-------|------|-------------|------------------|
| `transition_matrix` | object | Probability matrix showing P(next_state \| current_state) for all state pairs. | Shows how customers move between touchpoints. High probabilities indicate strong sequential patterns. |
| `transition_matrix.{state}.{next_state}` | float | Transition probability from state to next_state (0-1). | Likelihood that to customer at {state} will next visit {next_state}. |
| `conversion_probabilities` | object | Probability of eventual conversion from each state. | Indicates which touchpoints are strongest conversion indicators. Higher = better conversion predictor. |
| `conversion_probabilities.{state}` | float | P(conversion \| currently at state). Calculated using absorbing Markov chain analysis. | Conversion likelihood for customers currently at this touchpoint. |
| `critical_paths` | array | High-probability journey sequences that lead to conversion. | Most effective customer journey patterns. Optimize these paths for maximum conversion impact. |
| `critical_paths[].path` | array | Ordered sequence of touchpoints in the journey. | Specific touchpoint sequence that drives conversions. |
| `critical_paths[].probability` | float | Probability of this exact path occurring and converting (0-1). | How often this successful path happens. Focus on high-probability paths. |
| `critical_paths[].avg_revenue` | float | Average revenue generated by journeys following this path. | Revenue value of this journey pattern. Prioritize high-revenue paths. |
| `critical_paths[].frequency` | integer | Number of journeys that followed this path. | Volume of customers taking this path. High frequency = repeatable pattern. |
| `critical_paths[].avg_path_length` | float | Average number of touchpoints in this path. | Journey complexity. Shorter paths may indicate efficiency. |
| `journey_metrics` | object | Aggregate statistics across all analyzed journeys. | Overall journey performance and complexity metrics. |
| `journey_metrics.avg_path_length_to_conversion` | float | Average touchpoints before conversion. | Journey efficiency. Lower = faster conversions. |
| `journey_metrics.avg_path_length_to_abeonment` | float | Average touchpoints before abeonment. | When customers typically drop off. |
| `journey_metrics.overall_conversion_rate` | float | Percentage of journeys ending in conversion (0-1). | Overall Sucesso rate of customer journeys. |
| `journey_metrics.total_journeys_analyzed` | integer | Total number of customer journeys in the analysis. | Sample size for statistical confidence. |
| `journey_metrics.unique_states` | integer | Number of distinct touchpoint types. | Journey complexity and channel diversity. |
| `journey_metrics.total_transitions` | integer | Total touchpoint-to-touchpoint transitions observed. | Data volume for transition probability accuracy. |
| `absorbing_states_distribution` | object | Distribution of final journey outcomes. | How journeys ultimately end (conversion vs. abeonment rates). |

## Status HTTP

| Status Código | Description |
|-------------|-------------|
| 200 OK | Request successful. Returns customer journey Markov analysis results. |
| 400 Bad Request | Invalid request Parâmetros. Check Parâmetro types and Obrigatório fields. |
| 401 Unauthorized | Missing or invalid Bearer token. |
| 403 Forbidden | Valid token but insufficient permissions. |
| 422 Unprocessable Entity | Request validation failed. See Resposta for details. |
| 429 Too Many Requests | Limite of taxa excedido. Retry after cooldown period. |
| 500 Internal Server Erro | Server Erro. Contact support if persistent. |
| 503 Service Unavailable | Serviço of IA temporariamente indisponível. Retry with exponential backoff. |

## Erros

### Common Erro Responses

#### Missing Obrigatório Parâmetros
```json
{
  "error": "Validation failed",
  "message": "Required parameter 'data' is missing",
  "code": "MISSING_PARAMETER",
  "details": {
    "parameter": "data",
    "location": "body"
  }
}
```

**Solution:** Ensure all Obrigatório Parâmetros are provided in the Corpo of the Requisição.

#### Invalid Autenticação
```json
{
  "error": "Unauthorized",
  "message": "Invalid or expired authentication token",
  "code": "AUTH_FAILED"
}
```

**Solution:** Verify Bearer token is valid and not expired. Check `X-Customer-Api-Id` e `X-Secret` Cabeçalhos.

## Typical Workflow

### 1. Data Collection and Preparation
Collect customer journey data from analytics platforms, CRM systems, and marketing automation tools:

```sql
-- Example: Extract journey data from clickstream database
SELECT
  user_id AS journey_id,
  JSON_ARRAYAGG(
    JSON_OBJECT(
      'event', event_name,
      'timestamp', event_timestamp,
      'metadata', event_metadata
    ) ORDER BY event_timestamp
  ) AS touchpoints,
  CASE
    WHEN MAX(is_conversion) = 1 THEN 'conversion'
    ELSE 'abandonment'
  END AS outcome,
  SUM(revenue) AS revenue
FROM clickstream_events
WHERE event_date >= DATE_SUB(CURDATE(), INTERVAL 90 DAY)
GROUP BY user_id, session_id
HAVING COUNT(*) >= 2;
```

### 2. Define Business Outcomes
Identify what constitutes journey Sucesso and failure:
- **Conversion:** Purchase, signup, subscription, qualified lead
- **Abeonment:** Session timeout, cart abeonment, site exit without conversion

### 3. API Request
Submit journey data to the Markov analysis Endpoint with appropriate Parâmetros:
- Set `min_support` to filter noise (0.01 = 1% minimum frequency)
- Use `max_order = 1` for first-order Markov (most common) or `max_order = 2` for deeper dependencies
- Enable `identify_critical_paths` to discover high-converting sequences

### 4. Analyze Transition Patterns
Review the transition matrix to underste customer flow:
- **High-probability transitions (>0.5):** Strong sequential patterns indicating natural customer flow
- **Low-probability transitions (<0.1):** Weak connections or dead ends requiring optimization
- **Abeonment transitions:** Identify where customers drop off most frequently

### 5. Identify Optimization Opportunities
Use conversion probabilities and critical paths to guide improvements:

**High-Converting Touchpoints:** Focus resources on touchpoints with conversion probability >0.40
- Increase visibility and traffic to these touchpoints
- Optimize content and user experience
- Use as entry points for marketing campaigns

**Weak Links:** Improve touchpoints with low conversion probability (<0.15)
- Redesign user experience
- Add calls-to-action or incentives
- Test alternative content or messaging

**Critical Path Optimization:** Enhance the top 3-5 critical paths
- Remove friction points in these sequences
- A/B test improvements on high-frequency paths
- Guide customers toward these proven paths

### 6. Implement Journey Improvements
Based on insights, make targeted changes:
- **Navigation:** Simplify paths to high-converting touchpoints
- **Content:** Optimize messaging at critical transition points
- **CTAs:** Add strategic calls-to-action before high-abeonment transitions
- **Personalization:** Guide customers along critical paths based on their current state

### 7. Monitor and Iterate
Re-run analysis periodically to measure improvement:
- Track changes in conversion probabilities over time
- Monitor emergence of new critical paths
- Measure overall conversion rate improvement
- Compare transition matrices before and after optimizations

## Perguntas Frequentes

### Q: What is the minimum number of journeys Obrigatório for reliable results?
A: For stable transition probabilities, provide at least 500 complete customer journeys. For statistical significance in critical path identification, 2,000+ journeys are recommended. The more data provided, the more accurate and granular the insights.

### Q: Should I use first-order (max_order=1) or second-order (max_order=2) Markov chains?
A: Start with first-order Markov chains (Padrão) which only consider the current touchpoint. Use second-order chains if you suspect that customer behavior depends on the previous 2 touchpoints, though this requires significantly more data (10x) and increases computational complexity. Most marketing use cases are well-served by first-order chains.

### Q: How of the I hele journeys with different lengths?
A: The Markov model naturally accommodates variable-length journeys. Shorter journeys (e.g., direct conversion paths) and longer journeys (e.g., extended research phases) are analyzed together, with transition probabilities normalized at each step. The `avg_path_length` metrics help you underste journey complexity.

### Q: What does to high transition probability mean in business terms?
A: A transition probability of 0.78 from "paid_search" to "website_visit" means that 78% of customers who click to paid search ad go directly to your website. High probabilities (>0.60) indicate strong, predictable customer flows. Low probabilities suggest customers are uncertain or finding alternative paths.

### Q: How can I use this for real-time personalization?
A: Use the `conversion_probabilities` to score customers in real-time based on their current touchpoint. If to customer is at to high-probability state (e.g., add_to_cart with 0.71 conversion probability), trigger immediate interventions like personalized offers or exit-intent popups to maximize conversion.

### Q: What if my conversion rate is very low (<5%)?
A: Low conversion rates are common in many industries. The Markov analysis is still valuable as it identifies the highest-converting paths within your data. Use the `critical_paths` to focus optimization efforts on proven sequences, even if overall conversion is low. Consider setting intermediate "micro-conversion" states (e.g., email signup, product view) as alternative absorbing states.

### Q: How often should I retrain the Markov model?
A: Retrain monthly for stable businesses, or weekly for fast-changing environments (e.g., seasonal retail, viral campaigns). Significant business changes (new product launches, website redesigns, marketing strategy shifts) require immediate retraining to capture new journey patterns.

### Q: Can I analyze multiple conversion types simultaneously?
A: Sim, define multiple absorbing states beyond just "conversion" e "abeonment." For example: `["purchase", "signup", "demo_request", "abeonment"]`. The model will calculate transition probabilities and conversion likelihoods for each outcome Tipo, enabling multi-goal journey optimization.

## Como é Calculado

The journey analysis uses Markov chain modeling to underste customer path probabilities and conversion likelihood:

### 1. Markov Chain Construction

The system builds to probabilistic state machine from customer journey data:

- **State Identification:** Each unique touchpoint (channel, page, action) becomes to state in the Markov chain
- **Transition Matrix:** Calculates probability P(state_j | state_i) for all state pairs based on observed journey sequences
- **Absorbing States:** Defines terminal states (conversion, abeonment) that customers cannot leave once entered

### 2. Transition Probability Calculation

- **Step 1:** Count all observed transitions from state i to state j across all customer journeys
- **Step 2:** Normalize by total transitions from state i to get P(j|i) = count(i→j) / sum(count(i→*))
- **Step 3:** Hele sparse data using Laplace smoothing (add-one smoothing) for rare transitions

### 3. Journey Analytics

- **Conversion Probability:** Calculate likelihood of reaching conversion from any state using absorbing chain analysis
- **Expected Path Length:** Compute mean number of steps to conversion or abeonment
- **Critical Paths:** Identify high-probability sequences that lead to conversion using Viterbi algorithm

### 4. Desempenho and Optimization

- **Tempo of Processamento:** 200-400ms for 50,000 journey sequences
- **Requisitos of Dados:** Minimum 500 complete journeys for stable transition probabilities
- **Memory Efficiency:** Uses sparse matrix representation for large state spaces (10,000+ states)

## Manuais Comerciais

| Use Case | Action | Expected Impact |
|----------|--------|-----------------|
| **Low Website-to-Cart Conversion** | If transition probability from "website_visit" to "add_to_cart" is <0.25, redesign product pages with clearer CTAs, add urgency signals (limited stock, countdown timers), and implement exit-intent offers. | Increase website-to-cart rate by 20-35%, improving overall conversion by 8-12%. |
| **High Cart Abeonment** | If transition probability from "add_to_cart" to "conversion" is <0.50, trigger abeoned cart email sequences within 1 hour, offer free shipping thresholds, simplify checkout process, add trust signals (security badges, money-back guarantee). | Recover 15-25% of abeoned carts, improving revenue by 10-18%. |
| **Paid Search Underperformance** | If "paid_search" conversion probability is <0.20, audit leing page relevance, improve ad-to-page message match, test different post-click paths, and consider adding retargeting pixels. | Improve paid search ROI by 25-40% through better conversion rates. |
| **Email Click Low Conversion** | If "email_click" has high initial engagement but low conversion probability (<0.25), optimize email-to-leing page experience, personalize post-click content, add limited-time offers to create urgency. | Increase email campaign ROI by 30-50% through higher conversion rates. |
| **Multi-Touch Journey Optimization** | For critical paths with 5+ touchpoints but high conversion probability, create marketing automation sequences that guide customers along these proven paths using triggered emails, retargeting, and personalized content. | Increase conversion rate for nurtured leads by 40-60% vs. reom touchpoint exposure. |
| **Identify Drop-Off Points** | Find touchpoints with high abeonment transitions (>0.40 abeonment rate), implement intervention strategies like live chat offers, personalized recommendations, or incentive offers at these critical moments. | Reduce abeonment rate by 20-30% at critical touchpoints, improving overall conversion by 5-10%. |

## Notes

### Data Preparation Melhores Práticas

**Journey Qualidade of Dados:**
- Ensure touchpoints are correctly ordered chronologically
- Remove duplicate touchpoints within short time windows (e.g., <1 minute)
- Use consistent naming conventions for touchpoint types across all journeys
- Include all relevant touchpoints, even those outside primary marketing channels

**Timestamp Precisão:**
- Use UTC timezone for all timestamps to ensure consistent ordering
- Include millisecond precision for events that occur in rapid succession
- Validate that touchpoint timestamps are within journey start/end bounds

**Outcome Definition:**
- Clearly define what constitutes conversion vs. abeonment for your business
- Consider intermediate outcomes (micro-conversions) for long sales cycles
- Ensure every journey has exactly one outcome state

### Otimização of Desempenho

- **Maximum Payload:** 50MB per request (~500,000 journeys)
- **Timeout:** 300 seconds (5 minutes) for very large datasets
- **Rate Limiting:** 50 requisições por minuto por tenant
- **Batch Processing:** For >1M journeys, split into multiple requests and aggregate results client-side

### Markov Model Assumptions

The first-order Markov assumption states that the next touchpoint depends only on the current touchpoint, not on the entire journey history. This simplification:

- **Works well when:** Customer behavior is primarily influenced by their most recent interaction
- **May underperform when:** Long-term context matters (e.g., bre awareness campaigns with 30+ day effects)
- **Solution:** Use `max_order = 2` for second-order Markov chains when context beyond immediate last step matters

### Interpretation Guidelines

**Transition Probability Ranges:**
- **0.60-1.00:** Very strong sequential pattern, highly predictable customer behavior
- **0.30-0.59:** Moderate connection, one of several likely next steps
- **0.10-0.29:** Weak connection, occasional path but not primary flow
- **<0.10:** Rare transition, potentially noise or outlier behavior

**Conversion Probability Benchmarks:**
- **>0.60:** Excellent conversion indicator, prioritize traffic to these touchpoints
- **0.40-0.59:** Good conversion indicator, optimize to push higher
- **0.20-0.39:** Fair conversion indicator, requires journey improvements
- **<0.20:** Poor conversion indicator, investigate barriers or redesign touchpoint

### Security and Compliance

- All journey data is encrypted in transit (TLS 1.3) and em repouso
- Customer identifiers (journey_id) are hashed internally for privacy
- Journey data is retained for 90 dias for model accuracy, then purged
- Metadata fields should not contain PII (personally identifiable information)

## Relacionado

- [Channel Attribution](ChannelAttribution.md) - Attribution modeling for marketing channel effectiveness
- [Journey Sequences](JourneySequences.md) - Sequential pattern mining for customer journeys
- [Propensity to Buy Product](../Propensity/PropensityBuyProduct.md) - Predict likelihood of product purchase
- [Recommend User Items](../Recommendations/RecommendUserItems.md) - Personalized item recommendations

## References

* Controlador: `src/Domain/ArtificialIntelligence/Http/Controllers/EchoIntelProxyController.php:303`
